name: Update NuGet Packages

on:
  schedule:
    # Run daily at 9:00 AM UTC
    - cron: '0 9 * * *'
  workflow_dispatch:
    inputs:
      includePrerelease:
        description: 'Include prerelease versions'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'
      dryRun:
        description: 'Dry run (no changes made)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

env:
  DOTNET_VERSION: '8.0.x'
  # Set to 'true' if you want scheduled runs to include prerelease versions
  SCHEDULED_INCLUDE_PRERELEASE: 'false'

# Required permissions for the workflow to:
# - Commit changes (contents: write)
# - Create pull requests (pull-requests: write)
# Note: Repository settings must allow GitHub Actions to create PRs:
# Settings ‚Üí Actions ‚Üí General ‚Üí Workflow permissions ‚Üí
# ‚úì Allow GitHub Actions to create and approve pull requests
permissions:
  contents: write
  pull-requests: write

jobs:
  update-packages:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Determine prerelease setting
        id: config
        shell: pwsh
        run: |
          $isScheduled = '${{ github.event_name }}' -eq 'schedule'

          if ($isScheduled) {
            $includePrerelease = '${{ env.SCHEDULED_INCLUDE_PRERELEASE }}'
            Write-Host "Scheduled run - using SCHEDULED_INCLUDE_PRERELEASE: $includePrerelease"
          } else {
            $includePrerelease = '${{ github.event.inputs.includePrerelease }}'
            Write-Host "Manual run - using input includePrerelease: $includePrerelease"
          }

          echo "includePrerelease=$includePrerelease" >> $env:GITHUB_OUTPUT

      - name: Update NuGet packages
        id: update
        shell: pwsh
        run: |
          $dryRun = '${{ github.event.inputs.dryRun }}' -eq 'true'
          $includePrerelease = '${{ steps.config.outputs.includePrerelease }}' -eq 'true'

          ./.github/workflows/scripts/Update-NuGetPackages.ps1 `
            -RootPath "${{ github.workspace }}" `
            -IncludePrerelease:$includePrerelease `
            -DryRun:$dryRun

      - name: Check for changes
        id: check-changes
        shell: bash
        run: |
          if [[ -n $(git status --porcelain) ]]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected in repository"
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes detected"
          fi

      - name: Find and build solutions
        if: steps.check-changes.outputs.has_changes == 'true'
        shell: bash
        run: |
          # Find all solution files recursively
          solutions=$(find . -name "*.sln" -type f)

          if [ -z "$solutions" ]; then
            echo "Error: No solution files found"
            exit 1
          fi

          echo "Found solution files:"
          echo "$solutions"

          # Initialize summary file
          echo "## üî® Build and Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Track overall status
          overall_errors=0
          overall_warnings=0

          # Process each solution
          for sln in $solutions; do
            sln_name=$(basename "$sln")
            echo ""
            echo "================================================"
            echo "Processing: $sln"
            echo "================================================"

            echo "### üìÅ $sln_name" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            echo "Restoring dependencies..."
            dotnet restore "$sln" 2>&1 | tee restore.log

            echo "Building solution (skipping dotnet format)..."
            dotnet build "$sln" --configuration Release --no-restore -p:SkipPreBuild=true 2>&1 | tee build.log
            build_exit=${PIPESTATUS[0]}

            # Parse build output for errors and warnings
            errors=$(grep -c "error [A-Z]*[0-9]*:" build.log || true)
            warnings=$(grep -c "warning [A-Z]*[0-9]*:" build.log || true)

            overall_errors=$((overall_errors + errors))
            overall_warnings=$((overall_warnings + warnings))

            if [ $build_exit -eq 0 ]; then
              echo "‚úÖ **Build:** Succeeded" >> $GITHUB_STEP_SUMMARY
            else
              echo "‚ùå **Build:** Failed" >> $GITHUB_STEP_SUMMARY
            fi
            echo "- Errors: $errors" >> $GITHUB_STEP_SUMMARY
            echo "- Warnings: $warnings" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # Show first 10 errors if any
            if [ $errors -gt 0 ]; then
              echo "<details><summary>üî¥ Build Errors</summary>" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              grep "error [A-Z]*[0-9]*:" build.log | head -10 >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "</details>" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi

            # Show first 10 warnings if any
            if [ $warnings -gt 0 ]; then
              echo "<details><summary>‚ö†Ô∏è Build Warnings</summary>" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              grep "warning [A-Z]*[0-9]*:" build.log | head -10 >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "</details>" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi

            # Only run tests if build succeeded
            if [ $build_exit -eq 0 ]; then
              echo "Running tests..."
              dotnet test "$sln" --configuration Release --no-build --verbosity normal 2>&1 | tee test.log
              test_exit=${PIPESTATUS[0]}

              if [ $test_exit -eq 0 ]; then
                echo "‚úÖ **Tests:** Passed" >> $GITHUB_STEP_SUMMARY
              else
                echo "‚ùå **Tests:** Failed" >> $GITHUB_STEP_SUMMARY
              fi
              echo "" >> $GITHUB_STEP_SUMMARY
            else
              echo "‚è≠Ô∏è **Tests:** Skipped (build failed)" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              exit 1
            fi

            echo "---" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          done

          # Add overall summary
          echo "## üìä Overall Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Total Errors:** $overall_errors" >> $GITHUB_STEP_SUMMARY
          echo "- **Total Warnings:** $overall_warnings" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Create Pull Request
        if: |
          github.event.inputs.dryRun != 'true' &&
          steps.check-changes.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore: update NuGet package versions'
          committer: GitHub Actions <actions@github.com>
          author: GitHub Actions <actions@github.com>
          branch: auto/update-nuget-packages
          delete-branch: true
          title: 'Update NuGet Packages to Latest Versions'
          body: |
            ## üîÑ Automated NuGet Package Updates

            This PR updates **${{ steps.update.outputs.package_count }}** NuGet package(s) to their latest versions within the same major version.

            ### üì¶ Package Updates

            ```
            ${{ steps.update.outputs.summary }}
            ```

            ### ‚úÖ Validation

            - [x] All packages updated successfully
            - [x] Solution builds without errors
            - [x] All tests pass
            - [x] Updates limited to same major version (no breaking changes)

            ### ü§ñ Automated Changes

            This PR was automatically generated by the [Update NuGet Packages workflow](${{ github.server_url }}/${{ github.repository }}/actions/workflows/update-nuget-packages.yml).

            **Include Prerelease:** ${{ steps.config.outputs.includePrerelease }}

            ---
            Please review the changes and merge if everything looks good.
          labels: |
            dependencies
            automated

      - name: Summary
        if: always()
        shell: pwsh
        run: |
          Write-Host "========== Workflow Summary ==========" -ForegroundColor Cyan

          if ('${{ steps.check-changes.outputs.has_changes }}' -eq 'true') {
            if ('${{ steps.update.outputs.has_updates }}' -eq 'true') {
              Write-Host "‚úÖ Package updates found and processed" -ForegroundColor Green
              Write-Host "   Updated ${{ steps.update.outputs.package_count }} package(s)" -ForegroundColor Cyan

              if (Test-Path "package-update-summary.txt") {
                Write-Host "`nPackage Updates:" -ForegroundColor Yellow
                Get-Content "package-update-summary.txt" | Write-Host
              }

              if ('${{ github.event.inputs.dryRun }}' -eq 'true') {
                Write-Host "`n‚ö†Ô∏è  Dry run mode - no PR created" -ForegroundColor Yellow
              }
            } else {
              Write-Host "‚ÑπÔ∏è  All packages are up to date" -ForegroundColor Cyan
            }
          } else {
            Write-Host "‚ÑπÔ∏è  No changes detected in repository" -ForegroundColor Cyan
          }
