name: Update NuGet Packages

on:
  schedule:
    # Run daily at 9:00 AM UTC
    - cron: '0 9 * * *'
  workflow_dispatch:
    inputs:
      includePrerelease:
        description: 'Include prerelease versions'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'
      dryRun:
        description: 'Dry run (no changes made)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

env:
  DOTNET_VERSION: '8.0.x'
  # Set to 'true' if you want scheduled runs to include prerelease versions
  SCHEDULED_INCLUDE_PRERELEASE: 'false'

# Required permissions for the workflow to:
# - Commit changes (contents: write)
# - Create pull requests (pull-requests: write)
# Note: Repository settings must allow GitHub Actions to create PRs:
# Settings ‚Üí Actions ‚Üí General ‚Üí Workflow permissions ‚Üí
# ‚úì Allow GitHub Actions to create and approve pull requests
permissions:
  contents: write
  pull-requests: write

jobs:
  update-packages:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Determine prerelease setting
        id: config
        shell: pwsh
        run: |
          $isScheduled = '${{ github.event_name }}' -eq 'schedule'

          if ($isScheduled) {
            $includePrerelease = '${{ env.SCHEDULED_INCLUDE_PRERELEASE }}'
            Write-Host "Scheduled run - using SCHEDULED_INCLUDE_PRERELEASE: $includePrerelease"
          } else {
            $includePrerelease = '${{ github.event.inputs.includePrerelease }}'
            Write-Host "Manual run - using input includePrerelease: $includePrerelease"
          }

          echo "includePrerelease=$includePrerelease" >> $env:GITHUB_OUTPUT

      - name: Update NuGet packages
        id: update
        shell: pwsh
        run: |
          $dryRun = '${{ github.event.inputs.dryRun }}' -eq 'true'
          $includePrerelease = '${{ steps.config.outputs.includePrerelease }}' -eq 'true'

          ./.github/workflows/scripts/Update-NuGetPackages.ps1 `
            -RootPath "${{ github.workspace }}" `
            -IncludePrerelease:$includePrerelease `
            -DryRun:$dryRun

      - name: Check for changes
        id: check-changes
        shell: bash
        run: |
          if [[ -n $(git status --porcelain) ]]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected in repository"
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes detected"
          fi

      - name: Find and build solutions
        if: steps.check-changes.outputs.has_changes == 'true'
        shell: bash
        run: |
          # Find all solution files recursively
          solutions=$(find . -name "*.sln" -type f)

          if [ -z "$solutions" ]; then
            echo "Error: No solution files found"
            exit 1
          fi

          echo "Found solution files:"
          echo "$solutions"

          # Process each solution
          for sln in $solutions; do
            echo ""
            echo "================================================"
            echo "Processing: $sln"
            echo "================================================"

            echo "Restoring dependencies..."
            dotnet restore "$sln"

            echo "Building solution..."
            dotnet build "$sln" --configuration Release --no-restore

            echo "Running tests..."
            dotnet test "$sln" --configuration Release --no-build --verbosity normal
          done

      - name: Create Pull Request
        if: |
          github.event.inputs.dryRun != 'true' &&
          steps.check-changes.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore: update NuGet package versions'
          committer: GitHub Actions <actions@github.com>
          author: GitHub Actions <actions@github.com>
          branch: auto/update-nuget-packages
          delete-branch: true
          title: 'Update NuGet Packages to Latest Versions'
          body: |
            ## üîÑ Automated NuGet Package Updates

            This PR updates NuGet packages to their latest versions.

            ### üì¶ Package Updates

            See the package update summary below:

            ```
            ${{ steps.update.outputs.summary }}
            ```

            ### ‚úÖ Validation

            - [x] All packages updated successfully
            - [x] Solution builds without errors
            - [x] All tests pass

            ### ü§ñ Automated Changes

            This PR was automatically generated by the [Update NuGet Packages workflow](${{ github.server_url }}/${{ github.repository }}/actions/workflows/update-nuget-packages.yml).

            **Include Prerelease:** ${{ steps.config.outputs.includePrerelease }}

            ---
            Please review the changes and merge if everything looks good.
          labels: |
            dependencies
            automated

      - name: Summary
        if: always()
        shell: pwsh
        run: |
          Write-Host "========== Workflow Summary ==========" -ForegroundColor Cyan

          if ('${{ steps.check-changes.outputs.has_changes }}' -eq 'true') {
            Write-Host "‚úÖ Package updates found and processed" -ForegroundColor Green

            if (Test-Path "package-update-summary.txt") {
              Write-Host "`nPackage Updates:" -ForegroundColor Yellow
              Get-Content "package-update-summary.txt" | Write-Host
            }

            if ('${{ github.event.inputs.dryRun }}' -eq 'true') {
              Write-Host "`n‚ö†Ô∏è  Dry run mode - no PR created" -ForegroundColor Yellow
            }
          } else {
            Write-Host "‚ÑπÔ∏è  All packages are up to date" -ForegroundColor Cyan
          }
