name: Post-Release Automation

# Triggers after a release is published
on:
  release:
    types: [published]

jobs:
  post-release:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout release branch
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.release.target_commitish }}
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Configure Git
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

    - name: Extract version info
      id: version
      run: |
        # Get current version from tag (e.g., v1.2.3 -> 1.2.3)
        CURRENT_VERSION="${{ github.event.release.tag_name }}"
        CURRENT_VERSION="${CURRENT_VERSION#v}"
        echo "current=$CURRENT_VERSION" >> $GITHUB_OUTPUT

        # Calculate next patch version (1.2.3 -> 1.2.4)
        IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"
        NEXT_VERSION="$MAJOR.$MINOR.$((PATCH + 1))"
        echo "next=$NEXT_VERSION" >> $GITHUB_OUTPUT

        # Get release date
        RELEASE_DATE=$(date +%Y-%m-%d)
        echo "date=$RELEASE_DATE" >> $GITHUB_OUTPUT

        # Get branch name
        BRANCH="${{ github.event.release.target_commitish }}"
        echo "branch=$BRANCH" >> $GITHUB_OUTPUT

        # Determine Umbraco version from branch
        if [[ "$BRANCH" == "release/v13.x" ]]; then
          echo "umbraco=13" >> $GITHUB_OUTPUT
        elif [[ "$BRANCH" == "release/v17.x" ]]; then
          echo "umbraco=17" >> $GITHUB_OUTPUT
        else
          echo "umbraco=Unknown" >> $GITHUB_OUTPUT
        fi

    - name: Update CHANGELOG.md
      run: |
        VERSION="${{ steps.version.outputs.current }}"
        NEXT_VERSION="${{ steps.version.outputs.next }}"
        DATE="${{ steps.version.outputs.date }}"
        UMBRACO="${{ steps.version.outputs.umbraco }}"

        # Create updated changelog
        awk -v ver="$VERSION" -v date="$DATE" -v umbraco="$UMBRACO" '
        BEGIN { found_unreleased=0; replaced=0 }
        /^## \[Unreleased\]/ {
          found_unreleased=1
          print "## [Unreleased]"
          print ""
          print "### Added"
          print ""
          print "### Changed"
          print ""
          print "### Fixed"
          print ""
          print "## [" ver "] - " date " (Umbraco " umbraco ")"
          replaced=1
          next
        }
        { print }
        ' CHANGELOG.md > CHANGELOG.tmp && mv CHANGELOG.tmp CHANGELOG.md

    - name: Bump version in .csproj
      run: |
        NEXT_VERSION="${{ steps.version.outputs.next }}"
        sed -i "s|<Version>.*</Version>|<Version>$NEXT_VERSION</Version>|" src/BulkUpload/BulkUpload.csproj

    - name: Create Pull Request
      uses: peter-evans/create-pull-request@v6
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: |
          chore: prepare for v${{ steps.version.outputs.next }} development

          Post-release automation:
          - Update CHANGELOG.md with v${{ steps.version.outputs.current }} release
          - Bump version to v${{ steps.version.outputs.next }} for next development cycle
        branch: chore/post-release-v${{ steps.version.outputs.current }}
        base: ${{ steps.version.outputs.branch }}
        title: "chore: post-release cleanup for v${{ steps.version.outputs.current }}"
        body: |
          ## Post-Release Automation

          This PR was automatically created after publishing release **v${{ steps.version.outputs.current }}**.

          ### Changes
          - âœ… Updated CHANGELOG.md with release v${{ steps.version.outputs.current }} (dated ${{ steps.version.outputs.date }})
          - âœ… Bumped version in BulkUpload.csproj to v${{ steps.version.outputs.next }}
          - âœ… Created new Unreleased section in CHANGELOG.md

          ### Next Steps
          1. Review the changes
          2. Merge this PR to complete the release cycle
          3. If this release needs to be cherry-picked to other branches (see [branching strategy](../docs/BRANCHING_STRATEGY.md)), do so manually

          ---

          ðŸ¤– Automated by post-release workflow
        labels: |
          chore
          automated
          post-release
