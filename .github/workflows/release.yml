name: Release to NuGet

# Multi-targeting release (v2.0.0+): Publish from main branch with both net8.0 and net10.0
on:
  release:
    types: [published]

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Verify release branch
      run: |
        BRANCH="${{ github.event.release.target_commitish }}"
        # v2.0.0+ releases from main (multi-targeted package)
        if [[ "$BRANCH" != "main" ]]; then
          echo "Error: v2.0.0+ releases must be from main branch (multi-targeted)"
          echo "Current branch: $BRANCH"
          exit 1
        fi
        echo "‚úì Release is from valid branch: $BRANCH"

    - name: Setup .NET 8
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x

    - name: Setup .NET 10
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 10.0.x

    - name: Cache NuGet packages
      uses: actions/cache@v4
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/packages.lock.json', '**/*.csproj') }}
        restore-keys: |
          ${{ runner.os }}-nuget-

    - name: Update csproj version from release tag
      run: |
        # Extract version from release tag (e.g., v1.0.0 -> 1.0.0)
        VERSION="${{ github.event.release.tag_name }}"
        VERSION="${VERSION#v}"  # Remove 'v' prefix if present

        # Update both projects to same version
        sed -i "s|<Version>.*</Version>|<Version>${VERSION}</Version>|" src/BulkUpload/BulkUpload.csproj
        sed -i "s|<Version>.*</Version>|<Version>${VERSION}</Version>|" src/BulkUpload.Core/BulkUpload.Core.csproj

        # Verify the update
        echo "Updated BulkUpload version to: ${VERSION}"
        grep "<Version>" src/BulkUpload/BulkUpload.csproj
        echo "Updated BulkUpload.Core version to: ${VERSION}"
        grep "<Version>" src/BulkUpload.Core/BulkUpload.Core.csproj

    - name: Setup Node.js (for Umbraco 17 frontend)
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'

    - name: Install npm dependencies (Umbraco 17 frontend)
      run: npm ci
      working-directory: src/BulkUpload/ClientV17

    - name: Build npm package (Umbraco 17 frontend)
      run: npm run build
      working-directory: src/BulkUpload/ClientV17

    - name: Restore dependencies
      run: dotnet restore src/BulkUpload/BulkUpload.csproj --disable-parallel

    - name: Build, test, and publish to NuGet
      shell: bash
      run: |
        # Initialize summary file
        echo "## üì¶ Release Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Release:** ${{ github.event.release.tag_name }}" >> $GITHUB_STEP_SUMMARY
        echo "**Branch:** ${{ github.event.release.target_commitish }}" >> $GITHUB_STEP_SUMMARY
        echo "**Targets:** net8.0 (Umbraco 13) and net10.0 (Umbraco 17)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # Build
        echo "## üî® Build Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        echo "Building project..."
        dotnet build src/BulkUpload/BulkUpload.csproj --configuration Release --no-restore -p:SkipPreBuild=true 2>&1 | tee build.log
        build_exit=${PIPESTATUS[0]}

        # Parse build output for errors and warnings
        errors=$(grep -c "error [A-Z]*[0-9]*:" build.log || true)
        warnings=$(grep -c "warning [A-Z]*[0-9]*:" build.log || true)

        if [ $build_exit -eq 0 ]; then
          echo "‚úÖ **Build:** Succeeded" >> $GITHUB_STEP_SUMMARY
        else
          echo "‚ùå **Build:** Failed" >> $GITHUB_STEP_SUMMARY
        fi
        echo "- Errors: $errors" >> $GITHUB_STEP_SUMMARY
        echo "- Warnings: $warnings" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # Show first 10 errors if any
        if [ $errors -gt 0 ]; then
          echo "<details><summary>üî¥ Build Errors</summary>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          grep "error [A-Z]*[0-9]*:" build.log | head -10 >> $GITHUB_STEP_SUMMARY || true
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "</details>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
        fi

        # Show first 10 warnings if any
        if [ $warnings -gt 0 ]; then
          echo "<details><summary>‚ö†Ô∏è Build Warnings</summary>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          grep "warning [A-Z]*[0-9]*:" build.log | head -10 >> $GITHUB_STEP_SUMMARY || true
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "</details>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
        fi

        # Exit if build failed
        if [ $build_exit -ne 0 ]; then
          echo "‚ùå Build failed, stopping release process" >> $GITHUB_STEP_SUMMARY
          exit 1
        fi

        # Run tests
        echo "## üß™ Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        echo "Running tests..."
        dotnet test src/BulkUpload.Tests/BulkUpload.Tests.csproj --configuration Release --no-build --verbosity normal 2>&1 | tee test.log
        test_exit=${PIPESTATUS[0]}

        # Parse test results
        total_tests=$(grep -oP 'Total tests: \K\d+' test.log || echo "0")
        passed_tests=$(grep -oP 'Passed: \K\d+' test.log || echo "0")
        failed_tests=$(grep -oP 'Failed: \K\d+' test.log || echo "0")
        skipped_tests=$(grep -oP 'Skipped: \K\d+' test.log || echo "0")
        test_time=$(grep -oP 'Total time: \K[\d.]+' test.log || echo "0")

        if [ $test_exit -eq 0 ]; then
          echo "‚úÖ **Tests:** Passed" >> $GITHUB_STEP_SUMMARY
        else
          echo "‚ùå **Tests:** Failed" >> $GITHUB_STEP_SUMMARY
        fi

        # Add test details
        if [ "$total_tests" != "0" ]; then
          echo "- Total: $total_tests" >> $GITHUB_STEP_SUMMARY
          echo "- Passed: $passed_tests ‚úÖ" >> $GITHUB_STEP_SUMMARY
          if [ "$failed_tests" != "0" ]; then
            echo "- Failed: $failed_tests ‚ùå" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "$skipped_tests" != "0" ]; then
            echo "- Skipped: $skipped_tests ‚è≠Ô∏è" >> $GITHUB_STEP_SUMMARY
          fi
          echo "- Duration: ${test_time}s ‚è±Ô∏è" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY

        # Show test failures if any
        if [ $test_exit -ne 0 ]; then
          echo "<details><summary>‚ùå Test Failures</summary>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          grep -A 5 "Failed!" test.log | head -20 >> $GITHUB_STEP_SUMMARY || true
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "</details>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "‚ùå Tests failed, stopping release process" >> $GITHUB_STEP_SUMMARY
          exit 1
        fi

        # Pack NuGet package
        echo "## üì¶ Package Creation" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        echo "Creating NuGet package..."
        dotnet pack src/BulkUpload/BulkUpload.csproj --configuration Release --no-build --output ./artifacts 2>&1 | tee pack.log
        pack_exit=${PIPESTATUS[0]}

        if [ $pack_exit -eq 0 ]; then
          # Get package info
          package_file=$(ls ./artifacts/*.nupkg | head -1)
          package_name=$(basename "$package_file")
          package_size=$(du -h "$package_file" | cut -f1)

          echo "‚úÖ **Package Created Successfully**" >> $GITHUB_STEP_SUMMARY
          echo "- Package: \`$package_name\`" >> $GITHUB_STEP_SUMMARY
          echo "- Size: $package_size" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
        else
          echo "‚ùå **Package Creation Failed**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "<details><summary>üî¥ Pack Errors</summary>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat pack.log >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "</details>" >> $GITHUB_STEP_SUMMARY
          exit 1
        fi

        # Publish to NuGet
        echo "## üöÄ NuGet Publishing" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        echo "Publishing to NuGet..."
        dotnet nuget push ./artifacts/*.nupkg --api-key ${{secrets.NUGET_API_KEY}} --source https://api.nuget.org/v3/index.json --skip-duplicate 2>&1 | tee publish.log
        publish_exit=${PIPESTATUS[0]}

        if [ $publish_exit -eq 0 ]; then
          echo "‚úÖ **Published to NuGet Successfully**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Package is now available at: https://www.nuget.org/packages/BulkUpload/${{ github.event.release.tag_name }}" >> $GITHUB_STEP_SUMMARY
        else
          # Check if it was skipped due to duplicate
          if grep -q "already exists" publish.log; then
            echo "‚ÑπÔ∏è **Package Already Exists on NuGet**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "This version was already published (--skip-duplicate was used)" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Publishing Failed**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "<details><summary>üî¥ Publish Errors</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat publish.log >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
        fi
        echo "" >> $GITHUB_STEP_SUMMARY

        # Overall Summary
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## üìä Overall Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Build Errors:** $errors" >> $GITHUB_STEP_SUMMARY
        echo "- **Build Warnings:** $warnings" >> $GITHUB_STEP_SUMMARY
        echo "- **Tests Passed:** $passed_tests/$total_tests" >> $GITHUB_STEP_SUMMARY
        echo "- **Package:** \`$package_name\` ($package_size)" >> $GITHUB_STEP_SUMMARY
        echo "- **Status:** üéâ Release completed successfully!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

    - name: Upload package artifact
      uses: actions/upload-artifact@v4
      with:
        name: nuget-package
        path: ./artifacts/*.nupkg
