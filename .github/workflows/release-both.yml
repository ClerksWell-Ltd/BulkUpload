name: Release Both Packages to NuGet

# Workflow to release both V13 and V17 packages simultaneously
# Only runs when creating a release from the main branch
on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 2.0.0)'
        required: true
        type: string

jobs:
  release-both:
    runs-on: ubuntu-latest
    # Only run this workflow for main branch releases
    if: github.event.release.target_commitish == 'main' || github.event_name == 'workflow_dispatch'

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Determine version
      id: version
      run: |
        if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          VERSION="${{ github.event.inputs.version }}"
        else
          VERSION="${{ github.event.release.tag_name }}"
          VERSION="${VERSION#v}"  # Remove 'v' prefix if present
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "âœ“ Release version: $VERSION"

    - name: Setup .NET 8
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x

    - name: Setup .NET 10
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 10.0.x

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'

    - name: Cache NuGet packages
      uses: actions/cache@v4
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/packages.lock.json', '**/*.csproj') }}
        restore-keys: |
          ${{ runner.os }}-nuget-

    - name: Cache npm packages
      uses: actions/cache@v4
      with:
        path: src/BulkUpload.V17/Client/node_modules
        key: ${{ runner.os }}-npm-${{ hashFiles('src/BulkUpload.V17/Client/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-npm-

    - name: Update versions in csproj files
      run: |
        VERSION="${{ steps.version.outputs.version }}"

        # Update V13 package version
        sed -i "s|<Version>.*</Version>|<Version>${VERSION}</Version>|" src/BulkUpload/BulkUpload.csproj
        echo "Updated V13 version to: ${VERSION}"
        grep "<Version>" src/BulkUpload/BulkUpload.csproj

        # Update V17 package version
        sed -i "s|<Version>.*</Version>|<Version>${VERSION}</Version>|" src/BulkUpload.V17/BulkUpload.V17.csproj
        echo "Updated V17 version to: ${VERSION}"
        grep "<Version>" src/BulkUpload.V17/BulkUpload.V17.csproj

        # Update Core package version
        sed -i "s|<Version>.*</Version>|<Version>${VERSION}</Version>|" src/BulkUpload.Core/BulkUpload.Core.csproj
        echo "Updated Core version to: ${VERSION}"
        grep "<Version>" src/BulkUpload.Core/BulkUpload.Core.csproj

    - name: Restore dependencies
      run: dotnet restore src/BulkUpload.sln --disable-parallel

    - name: Install V17 frontend dependencies
      working-directory: src/BulkUpload.V17/Client
      run: npm ci

    - name: Build V17 frontend
      working-directory: src/BulkUpload.V17/Client
      run: npm run build

    - name: Build solution
      run: |
        echo "## ðŸ”¨ Build Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        dotnet build src/BulkUpload.sln --configuration Release --no-restore -p:SkipPreBuild=true 2>&1 | tee build.log
        build_exit=${PIPESTATUS[0]}

        errors=$(grep -c "error [A-Z]*[0-9]*:" build.log || true)
        warnings=$(grep -c "warning [A-Z]*[0-9]*:" build.log || true)

        if [ $build_exit -eq 0 ]; then
          echo "âœ… **Build:** Succeeded" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Build:** Failed" >> $GITHUB_STEP_SUMMARY
          exit 1
        fi
        echo "- Errors: $errors" >> $GITHUB_STEP_SUMMARY
        echo "- Warnings: $warnings" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

    - name: Run tests
      run: |
        echo "## ðŸ§ª Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        dotnet test src/BulkUpload.sln --configuration Release --no-build --verbosity normal 2>&1 | tee test.log
        test_exit=${PIPESTATUS[0]}

        total_tests=$(grep -oP 'Total tests: \K\d+' test.log || echo "0")
        passed_tests=$(grep -oP 'Passed: \K\d+' test.log || echo "0")
        failed_tests=$(grep -oP 'Failed: \K\d+' test.log || echo "0")

        if [ $test_exit -eq 0 ]; then
          echo "âœ… **Tests:** Passed ($passed_tests/$total_tests)" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Tests:** Failed ($failed_tests failures)" >> $GITHUB_STEP_SUMMARY
          exit 1
        fi
        echo "" >> $GITHUB_STEP_SUMMARY

    - name: Pack V13 package
      run: |
        echo "## ðŸ“¦ Package Creation - V13" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        dotnet pack src/BulkUpload/BulkUpload.csproj --configuration Release --no-build --output ./artifacts/v13

        package_file=$(ls ./artifacts/v13/*.nupkg | head -1)
        package_name=$(basename "$package_file")
        package_size=$(du -h "$package_file" | cut -f1)

        echo "âœ… **V13 Package Created**" >> $GITHUB_STEP_SUMMARY
        echo "- Package: \`$package_name\`" >> $GITHUB_STEP_SUMMARY
        echo "- Size: $package_size" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

    - name: Pack V17 package
      run: |
        echo "## ðŸ“¦ Package Creation - V17" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        dotnet pack src/BulkUpload.V17/BulkUpload.V17.csproj --configuration Release --no-build --output ./artifacts/v17

        package_file=$(ls ./artifacts/v17/*.nupkg | head -1)
        package_name=$(basename "$package_file")
        package_size=$(du -h "$package_file" | cut -f1)

        echo "âœ… **V17 Package Created**" >> $GITHUB_STEP_SUMMARY
        echo "- Package: \`$package_name\`" >> $GITHUB_STEP_SUMMARY
        echo "- Size: $package_size" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

    - name: Publish V13 to NuGet
      run: |
        echo "## ðŸš€ NuGet Publishing - V13" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        dotnet nuget push ./artifacts/v13/*.nupkg \
          --api-key ${{secrets.NUGET_API_KEY}} \
          --source https://api.nuget.org/v3/index.json \
          --skip-duplicate 2>&1 | tee publish-v13.log

        if grep -q "already exists" publish-v13.log; then
          echo "â„¹ï¸ **V13 Package Already Exists**" >> $GITHUB_STEP_SUMMARY
        else
          echo "âœ… **V13 Published Successfully**" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY

    - name: Publish V17 to NuGet
      run: |
        echo "## ðŸš€ NuGet Publishing - V17" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        dotnet nuget push ./artifacts/v17/*.nupkg \
          --api-key ${{secrets.NUGET_API_KEY}} \
          --source https://api.nuget.org/v3/index.json \
          --skip-duplicate 2>&1 | tee publish-v17.log

        if grep -q "already exists" publish-v17.log; then
          echo "â„¹ï¸ **V17 Package Already Exists**" >> $GITHUB_STEP_SUMMARY
        else
          echo "âœ… **V17 Published Successfully**" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY

    - name: Upload package artifacts
      uses: actions/upload-artifact@v4
      with:
        name: nuget-packages
        path: |
          ./artifacts/v13/*.nupkg
          ./artifacts/v17/*.nupkg

    - name: Final summary
      run: |
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸŽ‰ Release Complete!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Version:** ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Packages:**" >> $GITHUB_STEP_SUMMARY
        echo "- [Umbraco.Community.BulkUpload](https://www.nuget.org/packages/Umbraco.Community.BulkUpload/${{ steps.version.outputs.version }}) (Umbraco 13)" >> $GITHUB_STEP_SUMMARY
        echo "- [Umbraco.Community.BulkUpload.V17](https://www.nuget.org/packages/Umbraco.Community.BulkUpload.V17/${{ steps.version.outputs.version }}) (Umbraco 17)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
