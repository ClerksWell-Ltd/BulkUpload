<div ng-controller="bulkUploadController" class="bulk-upload-dashboard">
    <!-- Page Header -->
    <div class="page-header">
        <div>
            <h1>Bulk Upload</h1>
            <p>Import content and media into your Umbraco site in bulk via CSV or ZIP files.</p>
            <div class="header-badge">
                <span class="dot"></span>
                Ready to import
            </div>
        </div>
    </div>

    <!-- Detection Badge (shown after file selection) -->
    <div ng-if="state.detection" class="detection-badge-container" style="margin-bottom: 20px;">
        <uui-badge color="positive" look="primary">
            üì¶ Detected: {{state.detection.summary}}
        </uui-badge>
    </div>

    <!-- Results Section -->
    <div ng-if="(state.results.content || state.results.media) && !state.loading" class="results-container">
        <!-- Content Results -->
        <div class="upload-card" ng-if="state.results.content">
            <div class="card-header">
                <div class="icon-circle green">‚úì</div>
                <div>
                    <h2>Content Import Results</h2>
                    <span class="subtitle">Summary of your content import</span>
                </div>
            </div>
            <div class="card-body">
                <div class="results-summary">
                    <div class="badge badge-total">
                        <strong>Total:</strong> {{state.results.content.totalCount}}
                    </div>
                    <div class="badge badge-success">
                        <strong>‚úì Success:</strong> {{state.results.content.successCount}}
                    </div>
                    <div ng-if="state.results.content.failureCount > 0" class="badge badge-failed">
                        <strong>‚úó Failed:</strong> {{state.results.content.failureCount}}
                    </div>
                </div>

                <div style="display: flex; gap: 10px;">
                    <uui-button label="Download Results CSV"
                                look="outline"
                                ng-click="onExportContentResultsClicked()"
                                ng-if="state.results.content.results && state.results.content.results.length > 0"
                                style="--uui-button-padding: 10px 20px;">
                        ‚¨á Download Results CSV
                    </uui-button>
                    <uui-button label="Clear Results"
                                look="outline"
                                ng-click="clearContentResults()"
                                style="--uui-button-padding: 10px 20px;">
                        Clear Results
                    </uui-button>
                </div>
            </div>
        </div>

        <!-- Media Results -->
        <div class="upload-card" ng-if="state.results.media">
            <div class="card-header">
                <div class="icon-circle green">‚úì</div>
                <div>
                    <h2>Media Import Results</h2>
                    <span class="subtitle">Summary of your media import</span>
                </div>
            </div>
            <div class="card-body">
                <div class="results-summary">
                    <div class="badge badge-total">
                        <strong>Total:</strong> {{state.results.media.totalCount}}
                    </div>
                    <div class="badge badge-success">
                        <strong>‚úì Success:</strong> {{state.results.media.successCount}}
                    </div>
                    <div ng-if="state.results.media.failureCount > 0" class="badge badge-failed">
                        <strong>‚úó Failed:</strong> {{state.results.media.failureCount}}
                    </div>
                </div>

                <div style="display: flex; gap: 10px;">
                    <uui-button label="Download Results CSV"
                                look="outline"
                                ng-click="onExportMediaResultsClicked()"
                                ng-if="state.results.media.results && state.results.media.results.length > 0"
                                style="--uui-button-padding: 10px 20px;">
                        ‚¨á Download Results CSV
                    </uui-button>
                    <uui-button label="Clear Results"
                                look="outline"
                                ng-click="clearMediaResults()"
                                style="--uui-button-padding: 10px 20px;">
                        Clear Results
                    </uui-button>
                </div>
            </div>
        </div>

        <!-- Media Preprocessing Results -->
        <div class="upload-card" ng-if="state.results.mediaPreprocessing">
            <div class="card-header">
                <div class="icon-circle green">‚úì</div>
                <div>
                    <h2>Media Preprocessing Results</h2>
                    <span class="subtitle">Media files created during content import</span>
                </div>
            </div>
            <div class="card-body">
                <div class="results-summary">
                    <div class="badge badge-total">
                        <strong>Total:</strong> {{state.results.mediaPreprocessing.length}}
                    </div>
                    <div class="badge badge-success">
                        <strong>‚úì Success:</strong> {{countSuccessfulMedia()}}
                    </div>
                    <div ng-if="countFailedMedia() > 0" class="badge badge-failed">
                        <strong>‚úó Failed:</strong> {{countFailedMedia()}}
                    </div>
                </div>

                <div style="display: flex; gap: 10px;">
                    <uui-button label="Download Media Results"
                                look="outline"
                                ng-click="onExportMediaPreprocessingResultsClicked()"
                                ng-if="state.results.mediaPreprocessing && state.results.mediaPreprocessing.length > 0"
                                style="--uui-button-padding: 10px 20px;">
                        ‚¨á Download Media Results
                    </uui-button>
                </div>
            </div>
        </div>
    </div>

    <!-- Upload Card -->
    <div class="upload-card">
        <div class="card-header">
            <div class="icon-circle green">‚ñ≤</div>
            <div>
                <h2>Upload File</h2>
                <span class="subtitle">Drag & drop or browse for your import file</span>
            </div>
        </div>
        <div class="card-body">
            <!-- Drop Zone -->
            <div class="drop-zone"
                 ng-if="!state.file"
                 ngf-drop
                 ngf-select
                 ng-model="uploadFile"
                 ngf-change="onFileSelected(uploadFile, $event)"
                 ngf-drag-over-class="'drop-zone-active'"
                 ngf-accept="'.csv,.zip'"
                 ngf-pattern="'.csv,.zip'">
                <div class="upload-icon">‚ñ≤</div>
                <h3>Drag files here or <em>browse</em></h3>
                <p>Select a CSV or ZIP file to start your import</p>
                <div class="file-types">
                    <span class="file-chip">.csv</span>
                    <span class="file-chip">.zip</span>
                </div>
            </div>

            <!-- File Preview -->
            <div class="file-preview" ng-if="state.file && !state.loading">
                <div class="file-icon">üìÑ</div>
                <div class="file-details">
                    <div class="file-name">{{state.file.name}}</div>
                    <div class="file-size">{{formatFileSize(state.file.size)}}</div>
                </div>
                <uui-button label="Clear"
                            look="outline"
                            ng-click="clearFile()">
                    Clear
                </uui-button>
            </div>

            <!-- Hidden File Input -->
            <input type="file"
                   id="unified-file-input"
                   ngf-select
                   ng-model="uploadFile"
                   ng-change="onFileSelected(uploadFile, $event)"
                   ng-disabled="state.loading"
                   accept=".csv,.zip" />

            <!-- Import Button -->
            <div class="btn-container">
                <uui-button label="Import"
                            look="primary"
                            color="positive"
                            ng-click="onUploadClicked()"
                            ng-disabled="!state.file || state.loading"
                            style="--uui-button-padding: 12px 28px;">
                    <span ng-if="!state.loading">‚ñ≤ Import</span>
                    <span ng-if="state.loading">Processing...</span>
                </uui-button>
            </div>
        </div>
    </div>

    <!-- Loading State -->
    <div ng-if="state.loading" class="loading-state">
        <uui-loader-bar style="color: #006eff"></uui-loader-bar>
        <p>Importing, please wait...</p>
    </div>

    <!-- Requirements Card -->
    <div class="requirements-card" ng-if="!state.loading">
        <details class="requirements-details">
            <summary class="card-header">
                <div class="icon-circle blue">‚Ñπ</div>
                <div>
                    <h2>Requirements & Help</h2>
                    <span class="subtitle">Everything you need to format your import file correctly</span>
                </div>
                <div class="toggle-icon">‚ñº</div>
            </summary>
            <div class="card-body">
            <!-- Supported Upload Types -->
            <div class="req-section">
                <div class="req-label">Supported Upload Types</div>
                <div class="media-tips">
                    <div class="media-tip">
                        <div class="tip-icon">üìÑ</div>
                        <strong>Media CSV:</strong> Import media items from URLs or file paths
                    </div>
                    <div class="media-tip">
                        <div class="tip-icon">üìÑ</div>
                        <strong>Content CSV:</strong> Import content nodes
                    </div>
                    <div class="media-tip">
                        <div class="tip-icon">üì¶</div>
                        <strong>ZIP with Media CSV:</strong> CSV for media import
                    </div>
                    <div class="media-tip">
                        <div class="tip-icon">üì¶</div>
                        <strong>ZIP with Content CSV:</strong> CSV for content import
                    </div>
                    <div class="media-tip">
                        <div class="tip-icon">üì¶</div>
                        <strong>ZIP with Media CSV + Content CSV:</strong> Import media first, then content
                    </div>
                    <div class="media-tip">
                        <div class="tip-icon">üì¶</div>
                        <strong>ZIP with Media CSV + Media Files:</strong> CSV references files in ZIP
                    </div>
                    <div class="media-tip">
                        <div class="tip-icon">üì¶</div>
                        <strong>ZIP with Content CSV + Media Files:</strong> Content references files via zipFileToMedia
                    </div>
                    <div class="media-tip">
                        <div class="tip-icon">üì¶</div>
                        <strong>ZIP with All Three:</strong> Media CSV processed first, then Content CSV with media files
                    </div>
                </div>
            </div>

            <!-- Content Import Requirements -->
            <div class="req-section">
                <div class="req-label">Content Import - Required Columns</div>

                <!-- Create Mode -->
                <div class="mode-subsection">
                    <div class="mode-header">
                        <span class="mode-badge create">Create Mode</span>
                        <span class="mode-desc">Creating new content items</span>
                    </div>
                    <div class="req-grid">
                        <div class="req-item">
                            <code>parent</code>
                            <div class="desc">Parent ID, GUID, or content path</div>
                            <div class="examples">
                                <span>1050</span>
                                <span>71332aa7-‚Ä¶</span>
                                <span>/news/2024/</span>
                            </div>
                        </div>
                        <div class="req-item">
                            <code>docTypeAlias</code>
                            <div class="desc">Content type alias</div>
                            <div class="examples">
                                <span>articlePage</span>
                            </div>
                        </div>
                        <div class="req-item">
                            <code>name</code>
                            <div class="desc">Content item name</div>
                            <div class="examples">
                                <span>My Article</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Update Mode -->
                <div class="mode-subsection">
                    <div class="mode-header">
                        <span class="mode-badge update">Update Mode</span>
                        <span class="mode-desc">Updating existing content items</span>
                    </div>
                    <div class="req-grid">
                        <div class="req-item">
                            <code>bulkUploadShouldUpdate</code>
                            <div class="desc">Set to true to enable update mode</div>
                            <div class="examples">
                                <span>true</span>
                            </div>
                        </div>
                        <div class="req-item">
                            <code>bulkUploadContentGuid</code>
                            <div class="desc">GUID of the content item to update</div>
                            <div class="examples">
                                <span>71332aa7-‚Ä¶</span>
                            </div>
                        </div>
                        <div class="req-item">
                            <code>parent</code>
                            <div class="desc">Parent ID, GUID, or content path (used to locate item)</div>
                            <div class="examples">
                                <span>1050</span>
                                <span>/news/2024/</span>
                            </div>
                        </div>
                        <div class="req-item">
                            <code>name</code>
                            <div class="desc">Name to match existing item</div>
                            <div class="examples">
                                <span>My Article</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Media Import Requirements -->
            <div class="req-section">
                <div class="req-label">Media Import - Required Columns</div>

                <!-- Create Mode -->
                <div class="mode-subsection">
                    <div class="mode-header">
                        <span class="mode-badge create">Create Mode</span>
                        <span class="mode-desc">Creating new media items</span>
                    </div>
                    <div class="req-grid">
                        <div class="req-item">
                            <code>fileName</code>
                            <div class="desc">For ZIP uploads: path to file within ZIP</div>
                            <div class="examples">
                                <span>image.jpg</span>
                                <span>photos/pic.png</span>
                            </div>
                        </div>
                        <div class="req-item">
                            <code>mediaSource|urlToStream</code>
                            <div class="desc">For URL imports</div>
                            <div class="examples">
                                <span>https://...</span>
                            </div>
                        </div>
                        <div class="req-item">
                            <code>mediaSource|pathToStream</code>
                            <div class="desc">For file path imports</div>
                            <div class="examples">
                                <span>C:\Images\...</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Update Mode -->
                <div class="mode-subsection">
                    <div class="mode-header">
                        <span class="mode-badge update">Update Mode</span>
                        <span class="mode-desc">Updating existing media items</span>
                    </div>
                    <div class="req-grid">
                        <div class="req-item">
                            <code>bulkUploadShouldUpdate</code>
                            <div class="desc">Set to true to enable update mode</div>
                            <div class="examples">
                                <span>true</span>
                            </div>
                        </div>
                        <div class="req-item">
                            <code>bulkUploadMediaGuid</code>
                            <div class="desc">GUID of the media item to update</div>
                            <div class="examples">
                                <span>a4f8bc21-‚Ä¶</span>
                            </div>
                        </div>
                        <div class="req-item">
                            <code>parent</code>
                            <div class="desc">Parent folder ID, GUID, or path (used to locate item)</div>
                            <div class="examples">
                                <span>1050</span>
                                <span>/media/images/</span>
                            </div>
                        </div>
                        <div class="req-item">
                            <code>name</code>
                            <div class="desc">Name to match existing media item</div>
                            <div class="examples">
                                <span>hero-image</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Additional Features -->
            <div class="req-section">
                <div class="req-label">Additional Features</div>
                <div class="media-tips">
                    <div class="media-tip">
                        <div class="tip-icon">üñº</div>
                        Reference media in content using resolvers like <code>heroImage|zipFileToMedia</code>
                    </div>
                    <div class="media-tip">
                        <div class="tip-icon">üë•</div>
                        Supports multi-CSV imports with automatic media deduplication
                    </div>
                    <div class="media-tip">
                        <div class="tip-icon">üìÑ</div>
                        Add extra CSV columns for any property on your doc type or media type
                    </div>
                    <div class="media-tip">
                        <div class="tip-icon">üìÅ</div>
                        Auto-creates parent folders for both content and media hierarchies
                    </div>
                </div>
            </div>
        </details>
    </div>

    <!-- ClerksWell Branding Footer -->
    <footer class="plugin-footer">
        <div class="divider"></div>
        <a href="https://www.clerkswell.com" target="_blank" rel="noopener noreferrer" class="brand-link">
            Made for the Umbraco Community with
            <span class="heart">‚ù§Ô∏è</span>
            from
            <img src="/App_Plugins/BulkUpload/images/cw-logo-primary-blue.png" alt="ClerksWell" />
        </a>
    </footer>
</div>
