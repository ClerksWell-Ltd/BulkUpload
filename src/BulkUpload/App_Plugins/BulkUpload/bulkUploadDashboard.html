<div ng-controller="bulkUploadController" class="bulk-upload-dashboard">
    <uui-box>
        <!-- Header with title -->
        <div slot="header" class="dashboard-header">
            <h2 class="dashboard-title">Bulk Upload</h2>
        </div>

        <!-- Tab navigation -->
        <uui-tab-group style="margin-bottom: 20px;">
            <uui-tab label="Content Import"
                     ng-click="setActiveTab('content')"
                     ng-attr-active="{{state.activeTab === 'content' ? 'true' : undefined}}">
                Content Import
            </uui-tab>
            <uui-tab label="Media Import"
                     ng-click="setActiveTab('media')"
                     ng-attr-active="{{state.activeTab === 'media' ? 'true' : undefined}}">
                Media Import
            </uui-tab>
        </uui-tab-group>

        <!-- Content Import Panel -->
        <div ng-show="state.activeTab === 'content'" class="tab-panel">
            <!-- Info Alert -->
            <uui-box look="outline" style="margin-bottom: 20px; border-color: #f0ad4e; background-color: #fcf8e3;">
                <div style="padding: 1em; color: #8a6d3b;">
                    <div style="display: flex; align-items: start; gap: 10px;">
                        <div style="font-size: 1.5em;">‚ÑπÔ∏è</div>
                        <div>
                            <h4 style="margin: 0 0 0.5em 0;">Requirements</h4>
                            <ul style="margin: 0.5em 0; padding-left: 1.5em;">
                                <li>The <code>parentId</code>, <code>docTypeAlias</code>, and <code>name</code> columns are required</li>
                                <li>Upload a ZIP file if you have media files to include with your content</li>
                                <li>Use resolvers like <code>zipFileToMedia</code> to reference media files</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </uui-box>

            <!-- Upload Section -->
            <uui-box headline="Upload File" style="margin-bottom: 20px;">
                <div style="padding: 1em;">
                    <div style="margin-bottom: 1em;">
                        <label for="content-file-input" style="display: block; font-weight: 600; margin-bottom: 0.5em;">
                            Select CSV or ZIP file
                        </label>
                        <input type="file"
                               id="content-file-input"
                               ngf-select
                               ng-model="bulkUploadImportFile"
                               ng-change="onFileSelected(bulkUploadImportFile, $event)"
                               ng-disabled="state.content.loading"
                               accept=".csv,.zip"
                               style="margin-bottom: 1em;" />
                    </div>

                    <!-- File preview -->
                    <div ng-if="state.content.file && !state.content.loading" class="file-info" style="margin-bottom: 1em; padding: 0.75em; background-color: #f5f5f5; border-radius: 4px; border-left: 3px solid #1b264f;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 1.2em;">üìÑ</span>
                            <div>
                                <strong>{{state.content.file.name}}</strong>
                                <span style="color: #666; margin-left: 8px;">({{formatFileSize(state.content.file.size)}})</span>
                            </div>
                        </div>
                    </div>

                    <div style="display: flex; gap: 10px;">
                        <uui-button label="Import Content"
                                    look="primary"
                                    color="positive"
                                    ng-click="onUploadClicked()"
                                    ng-disabled="!state.content.file || state.content.loading"
                                    style="--uui-button-padding: 10px 20px;">
                            <span ng-if="!state.content.loading">‚ñ≤ Import Content</span>
                            <span ng-if="state.content.loading">Processing...</span>
                        </uui-button>
                        <uui-button label="Clear File"
                                    look="outline"
                                    ng-if="state.content.file && !state.content.loading"
                                    ng-click="clearContentFile()"
                                    style="--uui-button-padding: 10px 20px;">
                            Clear
                        </uui-button>
                    </div>
                </div>
            </uui-box>

            <!-- Loading State -->
            <div ng-if="state.content.loading" style="margin-bottom: 20px;">
                <uui-loader-bar style="color: #006eff"></uui-loader-bar>
                <p style="text-align: center; color: #666; margin-top: 10px;">
                    Importing content, please wait...
                </p>
            </div>

            <!-- Results Section -->
            <uui-box ng-if="state.content.results && !state.content.loading" headline="Import Results" style="margin-bottom: 20px;">
                <div style="padding: 1em;">
                    <div class="results-summary" style="display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 1.5em;">
                        <div style="padding: 8px 16px; background-color: #f5f5f5; border-radius: 20px; border: 1px solid #ddd;">
                            <strong>Total:</strong> {{state.content.results.totalCount}}
                        </div>
                        <div style="padding: 8px 16px; background-color: #d4edda; border-radius: 20px; border: 1px solid #28a745; color: #155724;">
                            <strong>‚úì Success:</strong> {{state.content.results.successCount}}
                        </div>
                        <div ng-if="state.content.results.failureCount > 0" style="padding: 8px 16px; background-color: #f8d7da; border-radius: 20px; border: 1px solid #dc3545; color: #721c24;">
                            <strong>‚úó Failed:</strong> {{state.content.results.failureCount}}
                        </div>
                    </div>

                    <!-- Failed items detail -->
                    <details ng-if="state.content.results.failureCount > 0" style="margin-bottom: 1em; padding: 1em; background-color: #fff3cd; border-radius: 4px; border-left: 3px solid #ffc107;">
                        <summary style="cursor: pointer; font-weight: 600; margin-bottom: 0.5em;">
                            View Failed Items ({{state.content.results.failureCount}})
                        </summary>
                        <div style="margin-top: 1em; overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse; font-size: 0.9em;">
                                <thead>
                                    <tr style="background-color: #f5f5f5; border-bottom: 2px solid #ddd;">
                                        <th style="text-align: left; padding: 8px; font-weight: 600;">File Name</th>
                                        <th style="text-align: left; padding: 8px; font-weight: 600;">Error Message</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr ng-repeat="result in getFailedResults(state.content.results.results)" style="border-bottom: 1px solid #eee;">
                                        <td style="padding: 8px;">{{result.fileName}}</td>
                                        <td style="padding: 8px; color: #dc3545;">{{result.errorMessage}}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </details>

                    <div style="display: flex; gap: 10px;">
                        <uui-button label="Download Results CSV"
                                    look="outline"
                                    ng-click="onExportContentResultsClicked()"
                                    ng-if="state.content.results.results && state.content.results.results.length > 0"
                                    style="--uui-button-padding: 10px 20px;">
                            ‚¨á Download Results CSV
                        </uui-button>
                        <uui-button label="Clear Results"
                                    look="outline"
                                    ng-click="clearContentResults()"
                                    style="--uui-button-padding: 10px 20px;">
                            Clear Results
                        </uui-button>
                    </div>
                </div>
            </uui-box>
        </div>

        <!-- Media Import Panel -->
        <div ng-show="state.activeTab === 'media'" class="tab-panel">
            <!-- Info Alert -->
            <uui-box look="outline" style="margin-bottom: 20px; border-color: #0078d4; background-color: #e3f2fd;">
                <div style="padding: 1em; color: #01579b;">
                    <div style="display: flex; align-items: start; gap: 10px;">
                        <div style="font-size: 1.5em;">‚ÑπÔ∏è</div>
                        <div>
                            <h4 style="margin: 0 0 0.5em 0;">Instructions</h4>
                            <p style="margin: 0.5em 0;"><strong>Upload either:</strong></p>
                            <ul style="margin: 0.5em 0; padding-left: 1.5em;">
                                <li><strong>ZIP file:</strong> Contains a CSV file and the media files referenced in it</li>
                                <li><strong>CSV file only:</strong> If all media files are from URLs (use <code>mediaSource|urlToStream</code> column) or file paths</li>
                            </ul>
                            <p style="margin: 0.5em 0;">
                                <strong>Required CSV columns:</strong>
                                <ul>
                                    <li>
                                        <code>parent</code>
                                        <p>This is so we know where to save the media item. This can be an integer for the id in Umbraco e.g 1144, a guid for the id in Umbraco e.g. 71332aa7-8bea-44f1-9aa6-00de961b66e8, or a folder path e.g. /Social Icons/.</p>
                                    </li>

                                    <li>
                                        <code>fileName</code> or <code>mediaSource|urlToStream</code> or <code>mediaSource|urlToStream</code> or <code>mediaSource|pathToStream</code>
                                            <p>
                                                If you are using a zip file to upload the images with the CSV file then the fileName is required.<br />
                                                If the image is coming from a URL then the mediaSource|urlToStream is required
                                                If the image is from the local file system of the server, or network path then the mediaSource|pathToStream is required
                                            </p>
                                    </li>
                                </ul>
                            <p style="margin: 0.5em 0;"><strong>Optional CSV columns:</strong> <code>name</code>, <code>mediaTypeAlias</code>, plus any custom media properties e.g. <code>altText</code></p>
                        </div>
                    </div>
                </div>
            </uui-box>

            <!-- Upload Section -->
            <uui-box headline="Upload File" style="margin-bottom: 20px;">
                <div style="padding: 1em;">
                    <div style="margin-bottom: 1em;">
                        <label for="media-file-input" style="display: block; font-weight: 600; margin-bottom: 0.5em;">
                            Select ZIP or CSV file
                        </label>
                        <input type="file"
                               id="media-file-input"
                               ngf-select
                               ng-model="mediaUploadFile"
                               ng-change="onMediaFileSelected(mediaUploadFile, $event)"
                               ng-disabled="state.media.loading"
                               accept=".zip,.csv"
                               style="margin-bottom: 1em;" />
                    </div>

                    <!-- File preview -->
                    <div ng-if="state.media.file && !state.media.loading" class="file-info" style="margin-bottom: 1em; padding: 0.75em; background-color: #f5f5f5; border-radius: 4px; border-left: 3px solid #1b264f;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 1.2em;">üìÑ</span>
                            <div>
                                <strong>{{state.media.file.name}}</strong>
                                <span style="color: #666; margin-left: 8px;">({{formatFileSize(state.media.file.size)}})</span>
                            </div>
                        </div>
                    </div>

                    <div style="display: flex; gap: 10px;">
                        <uui-button label="Import Media"
                                    look="primary"
                                    color="positive"
                                    ng-click="onMediaUploadClicked()"
                                    ng-disabled="!state.media.file || state.media.loading"
                                    style="--uui-button-padding: 10px 20px;">
                            <span ng-if="!state.media.loading">‚ñ≤ Import Media</span>
                            <span ng-if="state.media.loading">Processing...</span>
                        </uui-button>
                        <uui-button label="Clear File"
                                    look="outline"
                                    ng-if="state.media.file && !state.media.loading"
                                    ng-click="clearMediaFile()"
                                    style="--uui-button-padding: 10px 20px;">
                            Clear
                        </uui-button>
                    </div>
                </div>
            </uui-box>

            <!-- Loading State -->
            <div ng-if="state.media.loading" style="margin-bottom: 20px;">
                <uui-loader-bar style="color: #006eff"></uui-loader-bar>
                <p style="text-align: center; color: #666; margin-top: 10px;">
                    Importing media, please wait...
                </p>
            </div>

            <!-- Results Section -->
            <uui-box ng-if="state.media.results && !state.media.loading" headline="Import Results" style="margin-bottom: 20px;">
                <div style="padding: 1em;">
                    <div class="results-summary" style="display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 1.5em;">
                        <div style="padding: 8px 16px; background-color: #f5f5f5; border-radius: 20px; border: 1px solid #ddd;">
                            <strong>Total:</strong> {{state.media.results.totalCount}}
                        </div>
                        <div style="padding: 8px 16px; background-color: #d4edda; border-radius: 20px; border: 1px solid #28a745; color: #155724;">
                            <strong>‚úì Success:</strong> {{state.media.results.successCount}}
                        </div>
                        <div ng-if="state.media.results.failureCount > 0" style="padding: 8px 16px; background-color: #f8d7da; border-radius: 20px; border: 1px solid #dc3545; color: #721c24;">
                            <strong>‚úó Failed:</strong> {{state.media.results.failureCount}}
                        </div>
                    </div>

                    <!-- Failed items detail -->
                    <details ng-if="state.media.results.failureCount > 0" style="margin-bottom: 1em; padding: 1em; background-color: #fff3cd; border-radius: 4px; border-left: 3px solid #ffc107;">
                        <summary style="cursor: pointer; font-weight: 600; margin-bottom: 0.5em;">
                            View Failed Items ({{state.media.results.failureCount}})
                        </summary>
                        <div style="margin-top: 1em; overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse; font-size: 0.9em;">
                                <thead>
                                    <tr style="background-color: #f5f5f5; border-bottom: 2px solid #ddd;">
                                        <th style="text-align: left; padding: 8px; font-weight: 600;">File Name</th>
                                        <th style="text-align: left; padding: 8px; font-weight: 600;">Error Message</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr ng-repeat="result in getFailedResults(state.media.results.results)" style="border-bottom: 1px solid #eee;">
                                        <td style="padding: 8px;">{{result.fileName}}</td>
                                        <td style="padding: 8px; color: #dc3545;">{{result.errorMessage}}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </details>

                    <div style="display: flex; gap: 10px;">
                        <uui-button label="Download Results CSV"
                                    look="outline"
                                    ng-click="onExportResultsClicked()"
                                    ng-if="state.media.results.results && state.media.results.results.length > 0"
                                    style="--uui-button-padding: 10px 20px;">
                            ‚¨á Download Results CSV
                        </uui-button>
                        <uui-button label="Clear Results"
                                    look="outline"
                                    ng-click="clearMediaResults()"
                                    style="--uui-button-padding: 10px 20px;">
                            Clear Results
                        </uui-button>
                    </div>
                </div>
            </uui-box>
        </div>
    </uui-box>
</div>
